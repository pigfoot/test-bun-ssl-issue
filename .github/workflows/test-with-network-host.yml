name: Test WITH --network=host (expect SUCCESS)

on:
  push:
    branches: [main]
  workflow_dispatch: {}

jobs:
  test:
    name: Build with --network=host
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Diagnose rootless environment
        run: |
          echo "=== Current User ==="
          whoami
          id

          echo "=== Check existing subuid/subgid ==="
          cat /etc/subuid || echo "No subuid file"
          cat /etc/subgid || echo "No subgid file"

          echo "=== Check user namespaces support ==="
          cat /proc/sys/kernel/unprivileged_userns_clone || echo "unprivileged_userns_clone not available"
          cat /proc/sys/user/max_user_namespaces || echo "max_user_namespaces not available"

          echo "=== Test user namespace creation ==="
          unshare --user --map-root-user echo "User namespace works" || echo "User namespace failed"

          echo "=== Setup subuid/subgid if missing ==="
          USER=$(whoami)
          grep -q "^${USER}:" /etc/subuid || echo "${USER}:100000:65536" | sudo tee -a /etc/subuid
          grep -q "^${USER}:" /etc/subgid || echo "${USER}:100000:65536" | sudo tee -a /etc/subgid

          echo "=== Final subuid/subgid ==="
          cat /etc/subuid
          cat /etc/subgid

      - name: Test mgoltzsche/podman-static first
        run: |
          echo "=== Testing mgoltzsche/podman-static ==="
          curl -fsSL -o /tmp/podman.tar.gz \
            https://github.com/mgoltzsche/podman-static/releases/latest/download/podman-linux-amd64.tar.gz
          cd /tmp && tar -xzf podman.tar.gz
          sudo cp -f podman-linux-amd64/usr/local/bin/* /usr/bin/
          podman --version
          echo "=== Test podman build with mgoltzsche version ==="
          cd /home/runner/work/test-bun-ssl-issue/test-bun-ssl-issue
          podman build --network=host --format docker -f Containerfile . || echo "mgoltzsche podman failed"

      - name: Install podman from rootless-static-toolkits
        run: |
          echo "=== Installing podman from rootless-static-toolkits ==="
          REPO="pigfoot/rootless-static-toolkits"
          ARCH=$([[ $(uname -m) == "aarch64" ]] && echo "arm64" || echo "amd64")
          TOOL="podman"
          TAG=$(curl -s "https://api.github.com/repos/${REPO}/releases" | \
            sed -n 's/.*"tag_name": "\('"${TOOL}"'-v[^"]*\)".*/\1/p' | head -1)
          mkdir -p $HOME/podman-install
          cd $HOME/podman-install
          curl -fsSL "https://github.com/${REPO}/releases/download/${TAG}/${TOOL}-full-linux-${ARCH}.tar.zst" | \
            zstd -d | tar xvf -
          cd ${TAG}
          sudo cp -a usr/* /usr/
          sudo cp -a etc/* /etc/
          podman --version

      - name: Build WITH --network=host (expect success)
        run: |
          echo "=== Building with --network=host ==="
          echo "This should SUCCEED"
          podman build --network=host --format docker -f Containerfile .
